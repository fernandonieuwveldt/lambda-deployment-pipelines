name: Deploy Lambda function with Docker container

env:
  ECR_REPOSITORY: {{ cookiecutter.ecr_repository }}
  LAMBDA_ROLE_ARN: {{ cookiecutter.lambda_role_arn }}
  LAMBDA_CONTAINER_NAME: {{ cookiecutter.lambda_container_name }}

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.9

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build and Push Docker Image
      uses: docker/build-push-action@v2
      with:
        context: .
        push: true
        tags: ${{ secrets.AWS_ACCOUNT }}.dkr.ecr.{{ secrets.AWS_REGION }}.amazonaws.com/$ECR_REPOSITORY:${{ github.sha }}
  
    - name: Deploy Lambda function
      run: |
        export IMAGE_TAG=${{ github.sha }}
        export IMAGE_URI=${{ secrets.AWS_ACCOUNT }}.dkr.ecr.{{ secrets.AWS_REGION }}.amazonaws.com/$ECR_REPOSITORY:${{ github.sha }}
        FUNCTION_ARN=$(aws lambda get-function --function-name $LAMBDA_CONTAINER_NAME --query 'Configuration.FunctionArn' --output text || true)
        
        if [ -z "$FUNCTION_ARN" ]; then
          aws lambda create-function \
              --function-name $LAMBDA_CONTAINER_NAME \
              --role arn:aws:iam::${{ secrets.AWS_ACCOUNT }}:role/service-role/$LAMBDA_ROLE_ARN \
              --package-type Image --code ImageUri=$IMAGE_URI \
              --timeout 15 \
              --memory-size 256
        else
         aws lambda update-function-code \
              --function-name $LAMBDA_CONTAINER_NAME \
              --image-uri $IMAGE_URI \
              --publish
        
        # wait for the lambda function to complete the update before applying any config
        aws lambda wait function-updated \
          --function-name $LAMBDA_CONTAINER_NAME

         aws lambda update-function-configuration \
           --function-name $LAMBDA_CONTAINER_NAME \
           --timeout 15 \
           --memory-size 256
        fi
